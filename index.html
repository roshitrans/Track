<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver Tracking - Roshi Transport</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <style>
        :root {
            --primary-gold: #FFD700;
            --primary-orange: #FFA500;
            --dark-brown: #2C1810;
            --medium-brown: #5D4037;
            --light-brown: #8D6E63;
            --cream: #FFF8E7;
            --light-cream: #FFFBF0;
            --peach: #FFE4B5;
            --green: #4CAF50;
            --red: #F44336;
            --blue: #2196F3;
        }

        [data-theme="dark"] {
            --cream: #1a1a1a;
            --light-cream: #252525;
            --peach: #3a3a3a;
            --dark-brown: #e0e0e0;
            --medium-brown: #b0b0b0;
            --light-brown: #909090;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, var(--cream) 0%, #F5E6D3 100%);
            overflow: hidden;
            position: relative;
        }

        .theme-toggle {
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 2000;
            background: var(--primary-gold);
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            font-size: 20px;
        }

        .theme-toggle:hover {
            transform: scale(1.1);
        }

        .container {
            display: flex;
            height: 100vh;
            flex-direction: column;
        }

        /* Sidebar */
        .sidebar {
            background: white;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 2px 0 15px rgba(0,0,0,0.1);
            z-index: 100;
            max-height: 40vh;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary-gold) 0%, var(--primary-orange) 100%);
            border-radius: 15px;
            box-shadow: 0 6px 20px rgba(255, 165, 0, 0.3);
        }

        .header h1 {
            color: var(--dark-brown);
            font-size: 1.5em;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .header p {
            color: var(--medium-brown);
            font-size: 0.9em;
        }

        .status-badge {
            display: inline-block;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85em;
            margin: 10px 0;
            animation: pulse 2s infinite;
        }

        .status-inactive {
            background: #f5f5f5;
            color: #757575;
        }

        .status-active {
            background: linear-gradient(135deg, var(--green) 0%, #45a049 100%);
            color: white;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.85; }
        }

        .driver-info {
            background: var(--light-cream);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.85em;
        }

        .info-row:last-child {
            margin-bottom: 0;
        }

        .info-label {
            color: var(--light-brown);
            font-weight: 500;
        }

        .info-value {
            color: var(--dark-brown);
            font-weight: 700;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            color: var(--medium-brown);
            font-size: 0.85em;
            font-weight: 600;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--peach);
            border-radius: 10px;
            font-family: 'Poppins', sans-serif;
            font-size: 0.95em;
            color: var(--dark-brown);
            transition: all 0.3s ease;
            background: var(--light-cream);
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary-gold);
            box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.1);
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }

        .btn {
            padding: 12px 16px;
            border: none;
            border-radius: 10px;
            font-family: 'Poppins', sans-serif;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-start {
            background: linear-gradient(135deg, var(--green) 0%, #45a049 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .btn-start:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(76, 175, 80, 0.4);
        }

        .btn-stop {
            background: linear-gradient(135deg, var(--red) 0%, #D32F2F 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3);
        }

        .btn-stop:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(244, 67, 54, 0.4);
        }

        .btn-update {
            background: linear-gradient(135deg, var(--primary-gold) 0%, var(--primary-orange) 100%);
            color: var(--dark-brown);
            box-shadow: 0 4px 12px rgba(255, 165, 0, 0.3);
        }

        .btn-update:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(255, 165, 0, 0.4);
        }

        .btn-navigate {
            background: linear-gradient(135deg, var(--blue) 0%, #1976D2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
            grid-column: span 2;
        }

        .btn-navigate:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(33, 150, 243, 0.4);
        }

        /* Map Container */
        #map {
            flex: 1;
            height: 60vh;
            position: relative;
        }

        .map-overlay {
            position: absolute;
            top: 15px;
            left: 15px;
            background: white;
            padding: 12px 18px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            font-size: 0.85em;
        }

        .coord-display {
            color: var(--dark-brown);
            font-weight: 600;
        }

        /* Custom Leaflet Marker */
        .custom-marker {
            background: var(--primary-gold);
            border: 3px solid white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            animation: markerPulse 1.5s infinite;
        }

        @keyframes markerPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }

        .loading-overlay.show {
            display: flex;
        }

        .spinner {
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid var(--primary-gold);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Mobile Responsive */
        @media (min-width: 768px) {
            .container {
                flex-direction: row;
            }

            .sidebar {
                width: 380px;
                max-height: 100vh;
            }

            #map {
                height: 100vh;
            }
        }

        @media (max-width: 767px) {
            .sidebar {
                padding: 15px;
            }

            .header h1 {
                font-size: 1.3em;
            }

            .button-group {
                grid-template-columns: 1fr;
            }

            .btn-navigate {
                grid-column: span 1;
            }
        }

        /* Notification Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 2000;
            display: none;
            animation: slideIn 0.3s ease;
        }

        .toast.show {
            display: block;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast.error {
            background: #ffebee;
            color: var(--red);
        }

        .toast.success {
            background: #e8f5e9;
            color: var(--green);
        }
    </style>
</head>
<body>
    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark Mode">üåô</button>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <div class="toast" id="toast"></div>

    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="header">
                <h1>üöõ Driver Tracking</h1>
                <p>Roshi Transport Corporation</p>
            </div>

            <div class="status-badge" id="statusBadge">
                üî¥ Tracking Inactive
            </div>

            <div class="driver-info">
                <div class="info-row">
                    <span class="info-label">Driver:</span>
                    <span class="info-value" id="displayName">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Phone:</span>
                    <span class="info-value" id="displayPhone">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Last Update:</span>
                    <span class="info-value" id="lastUpdate">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Updates Sent:</span>
                    <span class="info-value" id="updateCount">0</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Speed:</span>
                    <span class="info-value" id="speedValue">- km/h</span>
                </div>
            </div>

            <div class="form-group">
                <label>Driver Name</label>
                <input type="text" id="driverName" placeholder="Enter your name">
            </div>

            <div class="form-group">
                <label>Mobile Number</label>
                <input type="tel" id="driverMobile" placeholder="10 digit number" maxlength="10">
            </div>

            <div class="button-group">
                <button class="btn btn-start" id="startBtn" onclick="startJourney()">
                    Start Journey
                </button>
                <button class="btn btn-stop" id="stopBtn" onclick="stopJourney()" disabled>
                    Stop Journey
                </button>
                <button class="btn btn-update" id="updateBtn" onclick="forceUpdate()" disabled>
                    Update Now
                </button>
                <button class="btn btn-navigate" id="navigateBtn" onclick="openNavigation()">
                    üß≠ Navigate Me
                </button>
            </div>
        </div>

        <!-- Map -->
        <div id="map"></div>
        <div class="map-overlay">
            <div class="coord-display" id="coordDisplay">
                üìç Waiting for location...
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script>
        // ==================== CONFIGURATION ====================
        const API_URL = 'https://script.google.com/macros/s/AKfycbxyirlhBcpliW0APbADmCc4Uhqmr2JGPyELFY8Jw1unHys7P-0Eu7Ooi3rFCFX6dFLv2w/exec';
        const POLL_INTERVAL = 5000; // Poll backend every 5 seconds
        const UPDATE_INTERVAL = 10000; // Send location every 10 seconds

        // ==================== STATE MANAGEMENT ====================
        let map, marker, polyline;
        let trackingActive = false;
        let pollingInterval = null;
        let updateInterval = null;
        let updateCount = 0;
        let pathCoordinates = [];
        let currentPosition = null;
        let routeOrigin = '';
        let routeDestination = '';
        let driverName = '';
        let driverPhone = '';

        // ==================== INITIALIZATION ====================
        window.onload = function() {
            initMap();
            loadURLParams();
            loadSavedData();
            acquireLocationFast();
        };

        // Initialize Leaflet map with OpenStreetMap tiles
        function initMap() {
            map = L.map('map').setView([25.7706, 73.0079], 13); // Default: Bhilwara
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            // Custom marker icon
            const customIcon = L.divIcon({
                className: 'custom-marker',
                iconSize: [24, 24]
            });

            marker = L.marker([25.7706, 73.0079], {icon: customIcon}).addTo(map);
            polyline = L.polyline([], {color: '#FFD700', weight: 4}).addTo(map);
        }

        // Load route params from URL
        function loadURLParams() {
            const params = new URLSearchParams(window.location.search);
            routeOrigin = params.get('origin') || '';
            routeDestination = params.get('destination') || '';
        }

        // Load saved tracking session
        function loadSavedData() {
            const saved = localStorage.getItem('roshiTracking');
            if (saved) {
                const data = JSON.parse(saved);
                document.getElementById('driverName').value = data.name || '';
                document.getElementById('driverMobile').value = data.phone || '';
                
                if (data.isTracking) {
                    driverName = data.name;
                    driverPhone = data.phone;
                    updateCount = data.updateCount || 0;
                    pathCoordinates = data.path || [];
                    resumeTracking();
                }
            }
        }

        // ==================== LOCATION ACQUISITION ====================
        // Fast location acquisition on page load
        function acquireLocationFast() {
            if (navigator.geolocation) {
                showLoading();
                navigator.geolocation.getCurrentPosition(
                    function(pos) {
                        hideLoading();
                        currentPosition = pos;
                        updateMapPosition(pos.coords.latitude, pos.coords.longitude);
                        updateCoordDisplay(pos.coords.latitude, pos.coords.longitude);
                        showToast('Location acquired successfully', 'success');
                    },
                    function(err) {
                        hideLoading();
                        showToast('Unable to get location. Enable GPS.', 'error');
                    },
                    { enableHighAccuracy: true, timeout: 8000, maximumAge: 0 }
                );
            }
        }

        // ==================== TRACKING FUNCTIONS ====================
        // Start tracking journey
        function startJourney() {
            const name = document.getElementById('driverName').value.trim();
            const phone = document.getElementById('driverMobile').value.trim();

            if (!name) {
                showToast('Please enter driver name', 'error');
                return;
            }

            if (!phone || phone.length !== 10 || !/^\d+$/.test(phone)) {
                showToast('Please enter valid 10 digit mobile', 'error');
                return;
            }

            driverName = name;
            driverPhone = phone;

            showLoading();
            
            // Get current location and start tracking immediately
            navigator.geolocation.getCurrentPosition(
                function(pos) {
                    currentPosition = pos;
                    sendStartRequest(pos.coords.latitude, pos.coords.longitude);
                },
                function(err) {
                    hideLoading();
                    showToast('Cannot start without location', 'error');
                },
                { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
            );
        }

        // Send start request to backend
        function sendStartRequest(lat, lng) {
            const payload = {
                action: "start",
                name: driverName,
                phone: driverPhone,
                latitude: lat,
                longitude: lng
            };

            fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(data => {
                hideLoading();
                if (data.status === 'success') {
                    activateTracking();
                    updateMapPosition(lat, lng);
                    pathCoordinates = [[lat, lng]];
                    updateCount = 1;
                    saveState();
                    showToast('Journey started successfully!', 'success');
                } else {
                    showToast('Failed to start: ' + (data.message || 'Unknown error'), 'error');
                }
            })
            .catch(err => {
                hideLoading();
                showToast('Network error: ' + err.message, 'error');
            });
        }

        // Activate tracking UI and intervals
        function activateTracking() {
            trackingActive = true;
            
            // Update UI
            document.getElementById('driverName').disabled = true;
            document.getElementById('driverMobile').disabled = true;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('updateBtn').disabled = false;
            document.getElementById('statusBadge').textContent = 'üü¢ Tracking Active';
            document.getElementById('statusBadge').className = 'status-badge status-active';
            document.getElementById('displayName').textContent = driverName;
            document.getElementById('displayPhone').textContent = driverPhone;

            // Start polling backend for status
            pollingInterval = setInterval(pollBackendStatus, POLL_INTERVAL);
            
            // Start sending location updates
            updateInterval = setInterval(sendLocationUpdate, UPDATE_INTERVAL);
        }

        // Resume tracking from saved state
        function resumeTracking() {
            activateTracking();
            document.getElementById('updateCount').textContent = updateCount;
            
            if (pathCoordinates.length > 0) {
                polyline.setLatLngs(pathCoordinates);
                const lastPos = pathCoordinates[pathCoordinates.length - 1];
                updateMapPosition(lastPos[0], lastPos[1]);
            }
        }

        // Poll backend every 5 seconds to check tracking state
        function pollBackendStatus() {
            if (!trackingActive || !driverPhone) return;

            fetch(`${API_URL}?action=status&phone=${driverPhone}`)
                .then(res => res.json())
                .then(data => {
                    if (data.trackingState === 'STOPPED') {
                        // Backend says stopped - force stop UI
                        forceStopUI();
                        showToast('Tracking stopped by administrator', 'error');
                    }
                })
                .catch(err => {
                    console.error('Polling error:', err);
                });
        }

        // Send location update to backend
        function sendLocationUpdate() {
            if (!trackingActive) return;

            navigator.geolocation.getCurrentPosition(
                function(pos) {
                    currentPosition = pos;
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;

                    const payload = {
                        action: "update",
                        phone: driverPhone,
                        latitude: lat,
                        longitude: lng
                    };

                    fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify(payload)
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.trackingState === 'STOPPED') {
                            forceStopUI();
                            return;
                        }

                        updateCount++;
                        document.getElementById('updateCount').textContent = updateCount;
                        document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('en-IN');
                        
                        // Update speed
                        const speed = pos.coords.speed ? Math.round(pos.coords.speed * 3.6) : 0;
                        document.getElementById('speedValue').textContent = speed + ' km/h';

                        // Update map and path
                        updateMapPosition(lat, lng, true);
                        pathCoordinates.push([lat, lng]);
                        polyline.setLatLngs(pathCoordinates);
                        
                        saveState();
                    })
                    .catch(err => {
                        console.error('Update error:', err);
                    });
                },
                function(err) {
                    console.error('Geolocation error:', err);
                },
                { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
            );
        }

        // Force update now
        function forceUpdate() {
            sendLocationUpdate();
            showToast('Location updated', 'success');
        }

        // Stop journey
        function stopJourney() {
            if (!confirm('Stop journey? This will end location tracking.')) return;

            showLoading();

            const payload = {
                action: "stop",
                phone: driverPhone
            };

            fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(data => {
                hideLoading();
                deactivateTracking();
                showToast('Journey stopped successfully!', 'success');
            })
            .catch(err => {
                hideLoading();
                deactivateTracking();
                showToast('Stopped (network error)', 'error');
            });
        }

        // Force stop from backend
        function forceStopUI() {
            deactivateTracking();
        }

        // Deactivate tracking
        function deactivateTracking() {
            trackingActive = false;
            
            if (pollingInterval) clearInterval(pollingInterval);
            if (updateInterval) clearInterval(updateInterval);

            document.getElementById('driverName').disabled = false;
            document.getElementById('driverMobile').disabled = false;
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('updateBtn').disabled = true;
            document.getElementById('statusBadge').textContent = 'üî¥ Tracking Inactive';
            document.getElementById('statusBadge').className = 'status-badge status-inactive';

            localStorage.removeItem('roshiTracking');
            pathCoordinates = [];
            updateCount = 0;
        }

        // ==================== MAP UPDATES ====================
        // Update map position with smooth animation
        function updateMapPosition(lat, lng, animate = false) {
            const newPos = [lat, lng];
            
            if (animate && marker) {
                // Smooth marker transition
                marker.setLatLng(newPos);
                map.panTo(newPos, { animate: true, duration: 1.0 });
            } else {
                marker.setLatLng(newPos);
                map.setView(newPos, 15);
            }

            updateCoordDisplay(lat, lng);
        }

        // Update coordinate display
        function updateCoordDisplay(lat, lng) {
            document.getElementById('coordDisplay').textContent = 
                `üìç ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        }

        // ==================== NAVIGATION ====================
        function openNavigation() {
            if (!routeOrigin || !routeDestination) {
                showToast('Route info not available', 'error');
                return;
            }

            const url = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(routeOrigin)}&destination=${encodeURIComponent(routeDestination)}&travelmode=driving`;
            window.open(url, '_blank');
        }

        // ==================== UTILITIES ====================
        function saveState() {
            const state = {
                name: driverName,
                phone: driverPhone,
                isTracking: trackingActive,
                updateCount: updateCount,
                path: pathCoordinates
            };
            localStorage.setItem('roshiTracking', JSON.stringify(state));
        }

        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('show');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('show');
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            const newTheme = current === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            document.querySelector('.theme-toggle').textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        }
    </script>
</body>
</html>
